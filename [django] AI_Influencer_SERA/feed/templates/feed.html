
{% extends 'main_layout.html' %}
{% load static %}

{% block title %}Ïö¥Îèô ÌîºÎìú - SERA{% endblock %}

{% block content %}
{% csrf_token %}
<!-- DEBUG: Posts count = {{ posts|length }} -->
{% if posts %}
    <!-- DEBUG: Posts found! -->
{% else %}
    <!-- DEBUG: No posts found! -->
{% endif %}

<style>
    body {
        background: #fafafa;
    }

    /* Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà Ïò§Î≤ÑÎùºÏù¥Îìú */
    .main-container {
        max-width: 600px;
        margin: 0 auto;
    }

    /* ÌîºÎìú Ìè¨Ïä§Ìä∏ */
    .feed-post {
        background: white;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    /* Ìè¨Ïä§Ìä∏ Ìó§Îçî */
    .post-header {
        padding: 15px 20px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid #efefef;
    }

    .profile-pic {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 12px;
        border: 2px solid #ff69b4;
    }

    .post-info h3 {
        font-size: 16px;
        font-weight: 600;
        color: #262626;
        margin-bottom: 2px;
    }

    .post-info .post-time {
        font-size: 12px;
        color: #8e8e8e;
    }

    /* Ìè¨Ïä§Ìä∏ Ïù¥ÎØ∏ÏßÄ */
    .post-image {
        width: 100%;
        aspect-ratio: 1 / 1;  /* 1:1 ÎπÑÏú® */
        object-fit: cover;
        display: block;
    }

    /* Ìè¨Ïä§Ìä∏ Ïï°ÏÖò */
    .post-actions {
        padding: 15px 20px 10px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .action-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #262626;
    }

    .action-btn:hover {
        transform: scale(1.1);
    }

    .action-btn.liked {
        color: #ff3040;
    }

    .likes-count {
        font-weight: 600;
        color: #262626;
        margin-left: auto;
    }

    /* Ìè¨Ïä§Ìä∏ ÎÇ¥Ïö© */
    .post-content {
        padding: 0 20px 15px;
    }

    .post-title {
        font-weight: 600;
        color: #262626;
        margin-bottom: 8px;
        font-size: 16px;
    }

    .post-text {
        color: #262626;
        line-height: 1.5;
        font-size: 14px;
        white-space: pre-line;
    }

    .hashtags {
        color: #00376b;
        font-weight: 500;
    }

    /* ÎåìÍ∏Ä ÏÑπÏÖò */
    .comments-section {
        border-top: 1px solid #efefef;
        padding: 15px 20px;
    }

    .comments-list {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 15px;
    }

    .comment-item {
        margin-bottom: 12px;
        font-size: 14px;
        line-height: 1.4;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 5px 0;
        border-radius: 5px;
        transition: all 0.2s ease;
    }

    .comment-item:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }

    .comment-author {
        font-weight: 600;
        color: #262626;
        margin-right: 8px;
    }

    .comment-text {
        color: #262626;
    }

    .comment-time {
        color: #8e8e8e;
        font-size: 12px;
        margin-top: 4px;
    }

    /* ÎåìÍ∏Ä ÏÇ≠Ï†ú Î≤ÑÌäº */
    .comment-delete {
        background: none;
        border: none;
        color: #8e8e8e;
        cursor: pointer;
        font-size: 14px;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s ease;
        margin-left: 8px;
    }

    .comment-delete:hover {
        background-color: #f5f5f5;
        color: #ed4956;
    }

    /* ÎåìÍ∏Ä ÏûÖÎ†• */
    .comment-form {
        display: flex;
        align-items: center;
        gap: 10px;
        padding-top: 10px;
        border-top: 1px solid #efefef;
    }

    .comment-input {
        flex: 1;
        border: none;
        outline: none;
        font-size: 14px;
        padding: 8px 0;
        font-family: inherit;
    }

    .comment-input::placeholder {
        color: #8e8e8e;
    }

    .comment-submit {
        background: none;
        border: none;
        color: #0095f6;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        padding: 8px 0;
        text-decoration: none;
    }

    .comment-submit:hover {
        color: #00376b;
    }

    .comment-submit:disabled {
        color: #c7c7c7;
        cursor: not-allowed;
    }

    /* ÎåìÍ∏Ä ÏÇ≠Ï†ú Î≤ÑÌäº */
    .comment-delete {
        background: none;
        border: none;
        color: #8e8e8e;
        font-size: 12px;
        cursor: pointer;
        margin-left: 10px;
        padding: 2px 5px;
        border-radius: 3px;
        transition: all 0.2s ease;
    }

    .comment-delete:hover {
        color: #ff3040;
        background-color: rgba(255, 48, 64, 0.1);
    }

    .comment-content {
        flex: 1;
    }

    /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
    @media (max-width: 768px) {
        .page-container {
            flex-direction: column;
        }

        .left-navbar {
            width: 100%;
            min-height: auto;
            padding: 15px;
        }

        .left-navbar a {
            display: inline-block;
            margin: 5px 10px 5px 0;
            padding: 5px 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            font-size: 14px;
        }

        .main-container {
            padding: 10px;
        }

        .form-group {
            flex-direction: column;
            gap: 10px;
        }

        .comment-input, .submit-btn {
            width: 100%;
        }

        .feed-header h1 {
            font-size: 1.8em;
        }
    }
</style>

<!-- ÌîºÎìú Ïª®ÌÖêÏ∏† -->
        {% for post in posts %}
        <div class="feed-post">
            <!-- Ìè¨Ïä§Ìä∏ Ìó§Îçî -->
            <div class="post-header">
                <img src="{% static 'images/profile_img_main.png' %}" alt="SERA" class="profile-pic">
                <div class="post-info">
                    <h3>sera_pilates</h3>
                    <div class="post-time">{{ post.created_at|timesince }} Ï†Ñ</div>
                </div>
            </div>

            <!-- Ìè¨Ïä§Ìä∏ Ïù¥ÎØ∏ÏßÄ -->
            <img src="{% static 'images/' %}{{ post.image }}" alt="{{ post.title }}" class="post-image">

            <!-- Ìè¨Ïä§Ìä∏ Ïï°ÏÖò -->
            <div class="post-actions">
                <button class="action-btn like-btn" onclick="toggleLike({{ post.id }})">
                    <span id="heart-{{ post.id }}">
                        {% if post.user_liked %}‚ù§Ô∏è{% else %}ü§ç{% endif %}
                    </span>
                </button>
                <button class="action-btn">üí¨</button>
                <button class="action-btn">üì§</button>
                <div class="likes-count" id="likes-{{ post.id }}">Ï¢ãÏïÑÏöî {{ post.get_likes_count }}Í∞ú</div>
            </div>

            <!-- Ìè¨Ïä§Ìä∏ ÎÇ¥Ïö© -->
            <div class="post-content">
                <div class="post-title">{{ post.title }}</div>
                <div class="post-text">{{ post.content }}</div>
            </div>

            <!-- ÎåìÍ∏Ä ÏÑπÏÖò -->
            <div class="comments-section">
                <div class="comments-list">
                    {% for comment in post.comments.all %}
                    <div class="comment-item" id="comment-{{ comment.id }}" style="display: flex; justify-content: space-between; align-items: flex-start; padding: 8px 0;">
                        <div class="comment-content" style="flex: 1;">
                            <span class="comment-author">{{ comment.author.username }}</span>
                            <span class="comment-text">{{ comment.content }}</span>
                            <div class="comment-time">{{ comment.created_at|timesince }} Ï†Ñ</div>
                        </div>
                        {% if user.is_authenticated and comment.author == user %}
                        <button class="comment-delete" onclick="deleteComment({{ comment.id }})" title="ÎåìÍ∏Ä ÏÇ≠Ï†ú">
                            ‚úï
                        </button>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <!-- ÎåìÍ∏Ä ÏûÖÎ†• -->
                {% if user.is_authenticated %}
                <form method="post" class="comment-form">
                    {% csrf_token %}
                    <input type="hidden" name="post_id" value="{{ post.id }}">
                    <input type="text"
                           name="comment"
                           class="comment-input"
                           placeholder="ÎåìÍ∏Ä Îã¨Í∏∞..."
                           required>
                    <button type="submit" class="comment-submit">Í≤åÏãú</button>
                </form>
                {% else %}
                <div class="comment-form">
                    <input type="text"
                           class="comment-input"
                           placeholder="ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±ÌïòÎ†§Î©¥ Î°úÍ∑∏Ïù∏ÌïòÏÑ∏Ïöî..."
                           disabled>
                    <a href="/login/" class="comment-submit">Î°úÍ∑∏Ïù∏</a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
{% endblock %}

{% block extra_js %}
<script>
    // Î©îÏãúÏßÄ ÏûêÎèô Ïà®ÍπÄ
    setTimeout(function() {
        const messages = document.querySelector('.messages');
        if (messages) {
            messages.style.display = 'none';
        }
    }, 5000);

    // Ï¢ãÏïÑÏöî ÌÜ†Í∏Ä Í∏∞Îä•
    function toggleLike(postId) {
        fetch(`/feed/like/${postId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const heart = document.getElementById(`heart-${postId}`);
                const likesCount = document.getElementById(`likes-${postId}`);

                // ÌïòÌä∏ ÏïÑÏù¥ÏΩò Î≥ÄÍ≤Ω
                heart.textContent = data.liked ? '‚ù§Ô∏è' : 'ü§ç';

                // Ï¢ãÏïÑÏöî Ïàò ÏóÖÎç∞Ïù¥Ìä∏
                likesCount.textContent = `Ï¢ãÏïÑÏöî ${data.likes_count}Í∞ú`;

                // Ïï†ÎãàÎ©îÏù¥ÏÖò Ìö®Í≥º
                heart.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    heart.style.transform = 'scale(1)';
                }, 200);
            } else {
                alert('Ï¢ãÏïÑÏöî Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Î°úÍ∑∏Ïù∏ÏùÑ ÌïòÏÑ∏Ïöî.');
        });
    }

    // Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú ÌôïÏù∏ ÌõÑ Ìà¨Ìëú ÌéòÏù¥ÏßÄ Ïù¥Îèô
    function checkLoginForVote() {
        fetch('/api/check-login/')
            .then(response => response.json())
            .then(data => {
                if (data.is_authenticated) {
                    window.location.href = '/vote/';
                } else {
                    alert('Î°úÍ∑∏Ïù∏ÏùÑ ÌïòÏÑ∏Ïöî.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Î°úÍ∑∏Ïù∏ÏùÑ ÌïòÏÑ∏Ïöî.');
            });
    }

    // Ï§ÄÎπÑ Ï§ë ÏïåÎ¶º
    function showComingSoon() {
        alert('Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§.');
    }

    // ÎåìÍ∏Ä ÏÇ≠Ï†ú Í∏∞Îä•
    function deleteComment(commentId) {
        console.log('ÎåìÍ∏Ä ÏÇ≠Ï†ú ÏãúÎèÑ:', commentId);

        if (!confirm('Ï†ïÎßêÎ°ú Ïù¥ ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
            return;
        }

        // CSRF ÌÜ†ÌÅ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            alert('CSRF ÌÜ†ÌÅ∞ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
            return;
        }

        fetch(`/feed/delete-comment/${commentId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken.value,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            console.log('ÏùëÎãµ ÏÉÅÌÉú:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:', data);
            if (data.success) {
                // ÎåìÍ∏Ä ÏöîÏÜåÎ•º Î∂ÄÎìúÎüΩÍ≤å Ï†úÍ±∞
                const commentElement = document.getElementById(`comment-${commentId}`);
                if (commentElement) {
                    commentElement.style.transition = 'all 0.3s ease';
                    commentElement.style.opacity = '0';
                    commentElement.style.transform = 'translateX(-20px)';

                    setTimeout(() => {
                        commentElement.remove();
                    }, 300);
                }

                // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
                console.log('ÎåìÍ∏ÄÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
            } else {
                alert(data.error || 'ÎåìÍ∏Ä ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ÎåìÍ∏Ä ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        });
    }

    // Î©îÏãúÏßÄ ÌëúÏãú Ìï®Ïàò
    function showMessage(message, type = 'success') {
        const messageDiv = document.createElement('div');
        messageDiv.className = `alert alert-${type}`;
        messageDiv.textContent = message;
        messageDiv.style.position = 'fixed';
        messageDiv.style.top = '80px';
        messageDiv.style.right = '20px';
        messageDiv.style.zIndex = '1001';
        messageDiv.style.padding = '12px 20px';
        messageDiv.style.borderRadius = '5px';
        messageDiv.style.fontWeight = '500';

        if (type === 'success') {
            messageDiv.style.backgroundColor = '#d4edda';
            messageDiv.style.color = '#155724';
            messageDiv.style.border = '1px solid #c3e6cb';
        } else {
            messageDiv.style.backgroundColor = '#f8d7da';
            messageDiv.style.color = '#721c24';
            messageDiv.style.border = '1px solid #f5c6cb';
        }

        document.body.appendChild(messageDiv);

        setTimeout(() => {
            messageDiv.style.transition = 'opacity 0.3s ease';
            messageDiv.style.opacity = '0';
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 300);
        }, 3000);
    }

    // ÎåìÍ∏Ä ÏûÖÎ†• Ïãú Î≤ÑÌäº ÌôúÏÑ±Ìôî/ÎπÑÌôúÏÑ±Ìôî
    document.addEventListener('DOMContentLoaded', function() {
        const commentInputs = document.querySelectorAll('.comment-input');
        commentInputs.forEach(input => {
            const submitBtn = input.nextElementSibling;
            if (submitBtn && submitBtn.classList.contains('comment-submit')) {
                input.addEventListener('input', function() {
                    if (this.value.trim()) {
                        submitBtn.disabled = false;
                        submitBtn.style.color = '#0095f6';
                    } else {
                        submitBtn.disabled = true;
                        submitBtn.style.color = '#c7c7c7';
                    }
                });
            }
        });
    });
</script>
{% endblock %}




