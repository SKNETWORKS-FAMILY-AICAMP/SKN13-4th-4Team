
{% extends 'main_layout.html' %}
{% load static %}

{% block title %}ìš´ë™ í”¼ë“œ - SERA{% endblock %}

{% block content %}
{% csrf_token %}
<!-- DEBUG: Posts count = {{ posts|length }} -->
{% if posts %}
    <!-- DEBUG: Posts found! -->
{% else %}
    <!-- DEBUG: No posts found! -->
{% endif %}

<style>
    body {
        background: #fafafa;
    }

    /* í˜ì´ì§€ ì»¨í…Œì´ë„ˆ */
    .page-container {
        display: flex;
        min-height: calc(100vh - 70px);
    }

    /* ì™¼ìª½ ë„¤ë¹„ê²Œì´ì…˜ ë°” */
    .left-navbar {
        background-color: hotpink;
        width: 200px;
        padding: 20px;
        color: white;
        min-height: calc(100vh - 70px);
    }

    .left-navbar h2 {
        color: white;
        margin-bottom: 20px;
    }

    .left-navbar h2 a {
        color: white;
        text-decoration: none;
    }

    .left-navbar a {
        color: white;
        display: block;
        margin: 10px 0;
        text-decoration: none;
        font-weight: bold;
        padding: 8px 0;
        transition: all 0.3s ease;
    }

    .left-navbar a:hover {
        background-color: rgba(255, 255, 255, 0.1);
        padding-left: 10px;
        border-radius: 5px;
    }

    /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
    .main-container {
        flex: 1;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        min-height: calc(100vh - 70px);
    }

    /* í”¼ë“œ í¬ìŠ¤íŠ¸ */
    .feed-post {
        background: white;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    /* í¬ìŠ¤íŠ¸ í—¤ë” */
    .post-header {
        padding: 15px 20px;
        display: flex;
        align-items: center;
        border-bottom: 1px solid #efefef;
    }

    .profile-pic {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 12px;
        border: 2px solid #ff69b4;
    }

    .post-info h3 {
        font-size: 16px;
        font-weight: 600;
        color: #262626;
        margin-bottom: 2px;
    }

    .post-info .post-time {
        font-size: 12px;
        color: #8e8e8e;
    }

    /* í¬ìŠ¤íŠ¸ ì´ë¯¸ì§€ */
    .post-image {
        width: 100%;
        aspect-ratio: 1 / 1;  /* 1:1 ë¹„ìœ¨ */
        object-fit: cover;
        display: block;
    }

    /* í¬ìŠ¤íŠ¸ ì•¡ì…˜ */
    .post-actions {
        padding: 15px 20px 10px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .action-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #262626;
    }

    .action-btn:hover {
        transform: scale(1.1);
    }

    .action-btn.liked {
        color: #ff3040;
    }

    .likes-count {
        font-weight: 600;
        color: #262626;
        margin-left: auto;
    }

    /* í¬ìŠ¤íŠ¸ ë‚´ìš© */
    .post-content {
        padding: 0 20px 15px;
    }

    .post-title {
        font-weight: 600;
        color: #262626;
        margin-bottom: 8px;
        font-size: 16px;
    }

    .post-text {
        color: #262626;
        line-height: 1.5;
        font-size: 14px;
        white-space: pre-line;
    }

    .hashtags {
        color: #00376b;
        font-weight: 500;
    }

    /* ëŒ“ê¸€ ì„¹ì…˜ */
    .comments-section {
        border-top: 1px solid #efefef;
        padding: 15px 20px;
    }

    .comments-list {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 15px;
    }

    .comment-item {
        margin-bottom: 12px;
        font-size: 14px;
        line-height: 1.4;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 5px 0;
        border-radius: 5px;
        transition: all 0.2s ease;
    }

    .comment-item:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }

    .comment-author {
        font-weight: 600;
        color: #262626;
        margin-right: 8px;
    }

    .comment-text {
        color: #262626;
    }

    .comment-time {
        color: #8e8e8e;
        font-size: 12px;
        margin-top: 4px;
    }

    /* ëŒ“ê¸€ ì‚­ì œ ë²„íŠ¼ */
    .comment-delete {
        background: none;
        border: none;
        color: #8e8e8e;
        cursor: pointer;
        font-size: 14px;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s ease;
        margin-left: 8px;
    }

    .comment-delete:hover {
        background-color: #f5f5f5;
        color: #ed4956;
    }

    /* ëŒ“ê¸€ ì…ë ¥ */
    .comment-form {
        display: flex;
        align-items: center;
        gap: 10px;
        padding-top: 10px;
        border-top: 1px solid #efefef;
    }

    .comment-input {
        flex: 1;
        border: none;
        outline: none;
        font-size: 14px;
        padding: 8px 0;
        font-family: inherit;
    }

    .comment-input::placeholder {
        color: #8e8e8e;
    }

    .comment-submit {
        background: none;
        border: none;
        color: #0095f6;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        padding: 8px 0;
        text-decoration: none;
    }

    .comment-submit:hover {
        color: #00376b;
    }

    .comment-submit:disabled {
        color: #c7c7c7;
        cursor: not-allowed;
    }

    /* ëŒ“ê¸€ ì‚­ì œ ë²„íŠ¼ */
    .comment-delete {
        background: none;
        border: none;
        color: #8e8e8e;
        font-size: 12px;
        cursor: pointer;
        margin-left: 10px;
        padding: 2px 5px;
        border-radius: 3px;
        transition: all 0.2s ease;
    }

    .comment-delete:hover {
        color: #ff3040;
        background-color: rgba(255, 48, 64, 0.1);
    }

    .comment-content {
        flex: 1;
    }

    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 768px) {
        .page-container {
            flex-direction: column;
        }

        .left-navbar {
            width: 100%;
            min-height: auto;
            padding: 15px;
        }

        .left-navbar a {
            display: inline-block;
            margin: 5px 10px 5px 0;
            padding: 5px 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            font-size: 14px;
        }

        .main-container {
            padding: 10px;
        }

        .form-group {
            flex-direction: column;
            gap: 10px;
        }

        .comment-input, .submit-btn {
            width: 100%;
        }

        .feed-header h1 {
            font-size: 1.8em;
        }
    }
</style>

<!-- í˜ì´ì§€ ì»¨í…Œì´ë„ˆ -->
<div class="page-container">
    <!-- ì™¼ìª½ ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
    <div class="left-navbar">
        <h2><a href="/">ì¬í™œ ìš´ë™ ì „ë¬¸ SERAğŸ’•</a></h2>
        <a href="/">í™ˆ</a>
        <a href="/chat/">ì¬í™œìš´ë™ ì§ˆë¬¸í•˜ê¸°</a>
        <a href="/feed/" style="background-color: rgba(255, 255, 255, 0.2); padding-left: 10px; border-radius: 5px;">ìš´ë™ í”¼ë“œ ë³´ê¸°</a>
        <a href="#" onclick="showComingSoon()">ì¶”ì²œ ìš´ë™ ì•„ì´í…œ</a>
        <a href="#" onclick="checkLoginForVote()">ë‹¤ìŒ ì»¨í…ì¸  íˆ¬í‘œ</a>
    </div>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div class="main-container">
        {% for post in posts %}
        <div class="feed-post">
            <!-- í¬ìŠ¤íŠ¸ í—¤ë” -->
            <div class="post-header">
                <img src="{% static 'images/profile_img_main.png' %}" alt="SERA" class="profile-pic">
                <div class="post-info">
                    <h3>sera_pilates</h3>
                    <div class="post-time">{{ post.created_at|timesince }} ì „</div>
                </div>
            </div>

            <!-- í¬ìŠ¤íŠ¸ ì´ë¯¸ì§€ -->
            <img src="{% static 'images/' %}{{ post.image }}" alt="{{ post.title }}" class="post-image">

            <!-- í¬ìŠ¤íŠ¸ ì•¡ì…˜ -->
            <div class="post-actions">
                <button class="action-btn like-btn" onclick="toggleLike({{ post.id }})">
                    <span id="heart-{{ post.id }}">
                        {% if post.user_liked %}â¤ï¸{% else %}ğŸ¤{% endif %}
                    </span>
                </button>
                <button class="action-btn">ğŸ’¬</button>
                <button class="action-btn">ğŸ“¤</button>
                <div class="likes-count" id="likes-{{ post.id }}">ì¢‹ì•„ìš” {{ post.get_likes_count }}ê°œ</div>
            </div>

            <!-- í¬ìŠ¤íŠ¸ ë‚´ìš© -->
            <div class="post-content">
                <div class="post-title">{{ post.title }}</div>
                <div class="post-text">{{ post.content }}</div>
            </div>

            <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
            <div class="comments-section">
                <div class="comments-list">
                    {% for comment in post.comments.all %}
                    <div class="comment-item" id="comment-{{ comment.id }}" style="display: flex; justify-content: space-between; align-items: flex-start; padding: 8px 0;">
                        <div class="comment-content" style="flex: 1;">
                            <span class="comment-author">{{ comment.author.username }}</span>
                            <span class="comment-text">{{ comment.content }}</span>
                            <div class="comment-time">{{ comment.created_at|timesince }} ì „</div>
                        </div>
                        {% if user.is_authenticated and comment.author == user %}
                        <button class="comment-delete" onclick="deleteComment({{ comment.id }})" title="ëŒ“ê¸€ ì‚­ì œ">
                            âœ•
                        </button>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <!-- ëŒ“ê¸€ ì…ë ¥ -->
                {% if user.is_authenticated %}
                <form method="post" class="comment-form">
                    {% csrf_token %}
                    <input type="hidden" name="post_id" value="{{ post.id }}">
                    <input type="text"
                           name="comment"
                           class="comment-input"
                           placeholder="ëŒ“ê¸€ ë‹¬ê¸°..."
                           required>
                    <button type="submit" class="comment-submit">ê²Œì‹œ</button>
                </form>
                {% else %}
                <div class="comment-form">
                    <input type="text"
                           class="comment-input"
                           placeholder="ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”..."
                           disabled>
                    <a href="/login/" class="comment-submit">ë¡œê·¸ì¸</a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ë©”ì‹œì§€ ìë™ ìˆ¨ê¹€
    setTimeout(function() {
        const messages = document.querySelector('.messages');
        if (messages) {
            messages.style.display = 'none';
        }
    }, 5000);

    // ì¢‹ì•„ìš” í† ê¸€ ê¸°ëŠ¥
    function toggleLike(postId) {
        fetch(`/feed/like/${postId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const heart = document.getElementById(`heart-${postId}`);
                const likesCount = document.getElementById(`likes-${postId}`);

                // í•˜íŠ¸ ì•„ì´ì½˜ ë³€ê²½
                heart.textContent = data.liked ? 'â¤ï¸' : 'ğŸ¤';

                // ì¢‹ì•„ìš” ìˆ˜ ì—…ë°ì´íŠ¸
                likesCount.textContent = `ì¢‹ì•„ìš” ${data.likes_count}ê°œ`;

                // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
                heart.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    heart.style.transform = 'scale(1)';
                }, 200);
            } else {
                alert('ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ë¡œê·¸ì¸ì„ í•˜ì„¸ìš”.');
        });
    }

    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ í›„ íˆ¬í‘œ í˜ì´ì§€ ì´ë™
    function checkLoginForVote() {
        fetch('/api/check-login/')
            .then(response => response.json())
            .then(data => {
                if (data.is_authenticated) {
                    window.location.href = '/vote/';
                } else {
                    alert('ë¡œê·¸ì¸ì„ í•˜ì„¸ìš”.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ë¡œê·¸ì¸ì„ í•˜ì„¸ìš”.');
            });
    }

    // ì¤€ë¹„ ì¤‘ ì•Œë¦¼
    function showComingSoon() {
        alert('ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.');
    }

    // ëŒ“ê¸€ ì‚­ì œ ê¸°ëŠ¥
    function deleteComment(commentId) {
        console.log('ëŒ“ê¸€ ì‚­ì œ ì‹œë„:', commentId);

        if (!confirm('ì •ë§ë¡œ ì´ ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            return;
        }

        // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
            alert('CSRF í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            return;
        }

        fetch(`/feed/delete-comment/${commentId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken.value,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            console.log('ì‘ë‹µ ìƒíƒœ:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('ì‘ë‹µ ë°ì´í„°:', data);
            if (data.success) {
                // ëŒ“ê¸€ ìš”ì†Œë¥¼ ë¶€ë“œëŸ½ê²Œ ì œê±°
                const commentElement = document.getElementById(`comment-${commentId}`);
                if (commentElement) {
                    commentElement.style.transition = 'all 0.3s ease';
                    commentElement.style.opacity = '0';
                    commentElement.style.transform = 'translateX(-20px)';

                    setTimeout(() => {
                        commentElement.remove();
                    }, 300);
                }

                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                console.log('ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                alert(data.error || 'ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showMessage(message, type = 'success') {
        const messageDiv = document.createElement('div');
        messageDiv.className = `alert alert-${type}`;
        messageDiv.textContent = message;
        messageDiv.style.position = 'fixed';
        messageDiv.style.top = '80px';
        messageDiv.style.right = '20px';
        messageDiv.style.zIndex = '1001';
        messageDiv.style.padding = '12px 20px';
        messageDiv.style.borderRadius = '5px';
        messageDiv.style.fontWeight = '500';

        if (type === 'success') {
            messageDiv.style.backgroundColor = '#d4edda';
            messageDiv.style.color = '#155724';
            messageDiv.style.border = '1px solid #c3e6cb';
        } else {
            messageDiv.style.backgroundColor = '#f8d7da';
            messageDiv.style.color = '#721c24';
            messageDiv.style.border = '1px solid #f5c6cb';
        }

        document.body.appendChild(messageDiv);

        setTimeout(() => {
            messageDiv.style.transition = 'opacity 0.3s ease';
            messageDiv.style.opacity = '0';
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 300);
        }, 3000);
    }

    // ëŒ“ê¸€ ì…ë ¥ ì‹œ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
    document.addEventListener('DOMContentLoaded', function() {
        const commentInputs = document.querySelectorAll('.comment-input');
        commentInputs.forEach(input => {
            const submitBtn = input.nextElementSibling;
            if (submitBtn && submitBtn.classList.contains('comment-submit')) {
                input.addEventListener('input', function() {
                    if (this.value.trim()) {
                        submitBtn.disabled = false;
                        submitBtn.style.color = '#0095f6';
                    } else {
                        submitBtn.disabled = true;
                        submitBtn.style.color = '#c7c7c7';
                    }
                });
            }
        });
    });
</script>
{% endblock %}




